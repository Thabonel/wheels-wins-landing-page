name: ğŸ›¡ï¸ Main Branch Protection

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate-main-deployment:
    name: ğŸ” Validate Main Branch Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ” Validate PUSH_TO_MAIN.md compliance
        run: npm run validate:main
        
      - name: ğŸ—ï¸ Test production build
        run: npm run build
        env:
          # Ensure we're using production URLs
          VITE_API_URL: https://pam-backend.onrender.com
          VITE_BACKEND_URL: https://pam-backend.onrender.com
          
      - name: ğŸ§ª Run quality checks
        run: npm run quality:check:full
        
      - name: ğŸ” Search for staging URLs (should fail if found)
        run: |
          echo "ğŸ” Searching for staging URLs that should not be in main..."
          
          # This should return empty (exit 0) or the job will fail
          if grep -r "wheels-wins-backend-staging" src/services/ 2>/dev/null; then
            echo "âŒ ERROR: Found staging backend URLs in src/services/"
            echo "ğŸ“š Please follow PUSH_TO_MAIN.md checklist"
            exit 1
          fi
          
          if grep -r "wheels-wins-staging.netlify.app" src/services/ 2>/dev/null; then
            echo "âŒ ERROR: Found staging frontend URLs in src/services/"
            echo "ğŸ“š Please follow PUSH_TO_MAIN.md checklist"
            exit 1
          fi
          
          echo "âœ… No staging URLs found - safe for production"
          
      - name: ğŸ“‹ Verify API_BASE_URL configuration
        run: |
          echo "ğŸ” Checking API_BASE_URL configuration..."
          
          # Check that api.ts has correct production URL
          if grep -A5 -B5 "API_BASE_URL" src/services/api.ts | grep -q "getApiBaseUrl\|currentDomain\|staging.*netlify"; then
            echo "âŒ ERROR: API_BASE_URL uses domain detection (not allowed in main)"
            echo "ğŸ“š Please follow PUSH_TO_MAIN.md checklist"
            exit 1
          fi
          
          if grep -A3 "API_BASE_URL.*=" src/services/api.ts | grep -q "pam-backend.onrender.com"; then
            echo "âœ… API_BASE_URL correctly set to production"
          else
            echo "âŒ ERROR: API_BASE_URL not set to production backend"
            echo "ğŸ“š Please follow PUSH_TO_MAIN.md checklist"
            exit 1
          fi
          
      - name: ğŸ¯ Production URL verification
        run: |
          echo "ğŸ¯ Final verification of production URLs..."
          echo ""
          echo "âœ… Expected configuration for main branch:"
          echo "   - API_BASE_URL: https://pam-backend.onrender.com"
          echo "   - No domain detection logic"
          echo "   - No staging URLs"
          echo "   - Production backend prioritized first"
          echo ""
          echo "ğŸš€ Main branch validation complete!"

  post-validation-reminder:
    name: ğŸ“‹ Post-Validation Reminder
    runs-on: ubuntu-latest
    needs: validate-main-deployment
    if: success()
    
    steps:
      - name: ğŸ‰ Validation Success
        run: |
          echo "ğŸ‰ All validations passed!"
          echo ""
          echo "ğŸ“‹ Remember to verify after deployment:"
          echo "   â–¡ https://wheelsandwins.com loads without errors"
          echo "   â–¡ PAM connects to production backend"
          echo "   â–¡ No CORS errors in browser console"
          echo "   â–¡ Authentication works"
          echo "   â–¡ Voice functionality works"
          echo ""
          echo "ğŸš€ Safe to deploy to production!"