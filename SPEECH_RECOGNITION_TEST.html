<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Recognition Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f0f0f0;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            padding: 15px 30px; 
            margin: 10px; 
            font-size: 16px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .start { background-color: #4CAF50; color: white; }
        .stop { background-color: #f44336; color: white; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .listening { background-color: #e8f5e8; color: #2e7d32; }
        .stopped { background-color: #ffebee; color: #c62828; }
        .error { background-color: #fff3e0; color: #ef6c00; }
        .transcript { 
            background-color: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
            min-height: 100px;
        }
        .log { 
            background-color: #263238; 
            color: #4fc3f7; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Speech Recognition Test</h1>
        <p>This tool tests if speech recognition works in your browser for PAM voice features.</p>
        
        <div>
            <button id="startBtn" class="start">üé§ Start Listening</button>
            <button id="stopBtn" class="stop" disabled>üîá Stop Listening</button>
        </div>
        
        <div id="status" class="status stopped">üîá Not listening</div>
        
        <div>
            <h3>Speech Transcript:</h3>
            <div id="transcript" class="transcript">
                <em>Click "Start Listening" and speak to see your speech transcribed here...</em>
            </div>
        </div>
        
        <div>
            <h3>Wake Word Test:</h3>
            <p>Try saying:</p>
            <ul>
                <li><strong>"Hi PAM"</strong> - Should trigger wake word detection</li>
                <li><strong>"PAM what's the weather"</strong> - Should trigger conversation</li>
                <li><strong>"Hello world"</strong> - Should be transcribed but not trigger PAM</li>
            </ul>
        </div>
        
        <div>
            <h3>Debug Log:</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = false;
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const transcript = document.getElementById('transcript');
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function checkSpeechRecognitionSupport() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                addLog('‚ùå SpeechRecognition not supported in this browser');
                addLog('üí° Try using Chrome, Edge, or Safari');
                status.textContent = '‚ùå Speech Recognition not supported';
                status.className = 'status error';
                startBtn.disabled = true;
                return false;
            }
            
            addLog('‚úÖ SpeechRecognition is supported');
            return SpeechRecognition;
        }
        
        function initializeSpeechRecognition() {
            const SpeechRecognition = checkSpeechRecognitionSupport();
            if (!SpeechRecognition) return;
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            addLog('üîß Speech recognition configured');
            
            recognition.onstart = () => {
                addLog('üé§ Speech recognition started');
                isListening = true;
                status.textContent = 'üé§ Listening for speech...';
                status.className = 'status listening';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            };
            
            recognition.onresult = (event) => {
                const latest = event.results[event.results.length - 1];
                const transcriptText = latest[0].transcript;
                const confidence = latest[0].confidence;
                
                addLog(`üéôÔ∏è Speech: "${transcriptText}" (confidence: ${confidence?.toFixed(2) || 'N/A'}, final: ${latest.isFinal})`);
                
                // Update transcript display
                transcript.innerHTML = `<strong>Latest:</strong> ${transcriptText}<br><strong>Final:</strong> ${latest.isFinal ? 'Yes' : 'No'}<br><strong>Confidence:</strong> ${confidence?.toFixed(2) || 'N/A'}`;
                
                if (latest.isFinal) {
                    const lowerText = transcriptText.toLowerCase().trim();
                    
                    // Test wake word detection
                    if (lowerText.includes('hi pam') || lowerText.includes('hey pam') || lowerText.includes('hello pam')) {
                        addLog('‚úÖ WAKE WORD DETECTED: Hi PAM!');
                        transcript.innerHTML += '<br><br><span style="color: green; font-weight: bold;">üéâ Wake word "Hi PAM" detected!</span>';
                    } else if (lowerText.startsWith('pam ') || lowerText.includes(' pam ')) {
                        addLog('‚úÖ PAM CONVERSATION DETECTED!');
                        transcript.innerHTML += '<br><br><span style="color: blue; font-weight: bold;">üí¨ PAM conversation detected!</span>';
                    } else {
                        addLog('‚ÑπÔ∏è Speech detected but no PAM wake word');
                    }
                }
            };
            
            recognition.onerror = (event) => {
                addLog(`‚ùå Speech recognition error: ${event.error}`);
                
                if (event.error === 'not-allowed') {
                    addLog('üö´ Microphone permission denied');
                    status.textContent = 'üö´ Microphone permission denied';
                    status.className = 'status error';
                } else if (event.error === 'no-speech') {
                    addLog('üîá No speech detected');
                } else if (event.error === 'audio-capture') {
                    addLog('üé§ Audio capture error - check microphone');
                    status.textContent = 'üé§ Microphone error';
                    status.className = 'status error';
                } else if (event.error === 'network') {
                    addLog('üåê Network error');
                    status.textContent = 'üåê Network error';
                    status.className = 'status error';
                }
            };
            
            recognition.onend = () => {
                addLog('üîö Speech recognition ended');
                isListening = false;
                status.textContent = 'üîá Not listening';
                status.className = 'status stopped';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            };
        }
        
        startBtn.addEventListener('click', () => {
            if (recognition) {
                addLog('‚ñ∂Ô∏è Starting speech recognition...');
                try {
                    recognition.start();
                } catch (error) {
                    addLog(`‚ùå Failed to start: ${error.message}`);
                }
            }
        });
        
        stopBtn.addEventListener('click', () => {
            if (recognition && isListening) {
                addLog('‚èπÔ∏è Stopping speech recognition...');
                recognition.stop();
            }
        });
        
        // Initialize on page load
        addLog('üöÄ Initializing speech recognition test...');
        initializeSpeechRecognition();
        
        // Add browser info
        addLog(`üåê Browser: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`);
        addLog(`üîä Media devices available: ${navigator.mediaDevices ? 'Yes' : 'No'}`);
    </script>
</body>
</html>