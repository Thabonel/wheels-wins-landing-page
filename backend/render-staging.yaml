services:
  - type: web
    name: pam-backend-staging
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1
    plan: free  # Use free tier for staging
    branch: staging  # Deploy from staging branch
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: DEBUG
        value: true
      - key: PYTHONPATH
        value: /opt/render/project/src
      # Security keys - set in Render dashboard
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      # Required Supabase configuration (staging)
      - key: SUPABASE_URL
        sync: false  # Set manually in dashboard
      - key: SUPABASE_KEY
        sync: false  # Set manually in dashboard
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false  # Set manually in dashboard
      # Required OpenAI API Key
      - key: OPENAI_API_KEY
        sync: false  # Set manually in dashboard
      # Redis for caching (auto-wired from pam-redis service)
      - key: REDIS_URL
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
      # TTS Configuration
      - key: TTS_ENABLED
        value: true
      - key: TTS_PRIMARY_ENGINE
        value: edge
      - key: TTS_FALLBACK_ENABLED
        value: true
      - key: TTS_VOICE_DEFAULT
        value: en-US-AriaNeural
      # Email Service (Resend API for Celery workers)
      - key: RESEND_API_KEY
        sync: false  # Set manually in dashboard - required for automated emails
      # CORS Configuration for staging
      - key: CORS_ALLOWED_ORIGINS
        value: "https://staging-wheelsandwins.netlify.app,https://wheels-wins-staging.netlify.app,http://localhost:8080,http://localhost:3000,http://localhost:5173"
      # Monitoring
      - key: SENTRY_DSN
        sync: false  # Set manually in dashboard if needed
      - key: SENTRY_ENVIRONMENT
        value: staging
    healthCheckPath: /health
    autoDeploy: true  # Enable auto-deploy from staging branch
    buildFilter:
      paths:
        - backend/**
      ignoredPaths:
        - backend/tests/**
        - backend/**/*.md
        - backend/.env
        - backend/.env.*
  # Redis cache service for PAM (staging) - using existing pam-redis service
  # Service already exists: red-d1venaur433s73fk12j0
  # No need to create new service, just reference existing one above

  # Celery Worker for PAM Proactive Tasks (staging)
  - type: worker
    name: pam-celery-worker-staging
    env: python
    runtime: python-3.11
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A app.workers.celery worker --loglevel=info --concurrency=2
    plan: free
    branch: staging
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: DEBUG
        value: true
      - key: PYTHONPATH
        value: /opt/render/project/src
      # Required Supabase configuration
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Required AI API Keys
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      # Redis for Celery (auto-wired from pam-redis service)
      - key: REDIS_URL
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
    autoDeploy: true

  # Celery Beat Scheduler for PAM Proactive Tasks (staging)
  - type: worker
    name: pam-celery-beat-staging
    env: python
    runtime: python-3.11
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A app.workers.celery beat --loglevel=info
    plan: free
    branch: staging
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: DEBUG
        value: true
      - key: PYTHONPATH
        value: /opt/render/project/src
      # Required Supabase configuration
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Required AI API Keys
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      # Redis for Celery (auto-wired from pam-redis service)
      - key: REDIS_URL
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: pam-redis
          property: connectionString
    autoDeploy: true