<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug QA Issues - Troubleshooting Tool</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        button {
            background: #000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        .secondary {
            background: #fff;
            color: #000;
            border: 1px solid #ddd;
        }
        .danger {
            background: #dc2626;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            color: #0c4a6e;
        }
        .error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }
        .success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }
        .warning {
            background: #fffbeb;
            border-color: #fde68a;
            color: #92400e;
        }
        pre {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .card h3 {
            margin-top: 0;
            color: #374151;
        }
        input[type="file"] {
            display: block;
            margin: 20px 0;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            width: 100%;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç QA Issues Debug Tool</h1>
        <p class="subtitle">Comprehensive troubleshooting for QA tracking data</p>
        
        <h2>1. Check Current Browser Storage</h2>
        <div>
            <button onclick="checkLocalStorage()">Check localStorage</button>
            <button onclick="checkAllStorage()" class="secondary">Check All Storage</button>
            <button onclick="exportLocalStorage()" class="secondary">Export localStorage to JSON</button>
        </div>
        <div id="storageStatus"></div>
        <pre id="storageData" style="display:none;"></pre>
        
        <h2>2. Recovery from JSON File</h2>
        <p>Upload the JSON file you're trying to import:</p>
        <input type="file" id="jsonFile" accept=".json,application/json" onchange="analyzeJSON(event)">
        <div id="jsonAnalysis"></div>
        <pre id="jsonData" style="display:none;"></pre>
        
        <h2>3. Manual Data Recovery</h2>
        <p>Paste your JSON data here if you have it:</p>
        <textarea id="manualJson" placeholder="Paste JSON data here..."></textarea>
        <button onclick="parseManualJSON()">Parse & Analyze</button>
        <button onclick="saveAsLocalStorage()" class="secondary">Save to localStorage</button>
        <button onclick="downloadAsJSON()" class="secondary">Download as JSON</button>
        <div id="manualStatus"></div>
        
        <h2>4. Create Test Data</h2>
        <div>
            <button onclick="createTestData()">Create Sample Issues</button>
            <button onclick="createFromYesterday()">Create Issues from Yesterday</button>
            <button onclick="clearLocalStorage()" class="danger">Clear localStorage</button>
        </div>
        <div id="testStatus"></div>
    </div>

    <div class="container">
        <h2>5. Diagnostics</h2>
        <div class="grid">
            <div class="card">
                <h3>Browser Info</h3>
                <div id="browserInfo"></div>
            </div>
            <div class="card">
                <h3>Storage Info</h3>
                <div id="storageInfo"></div>
            </div>
            <div class="card">
                <h3>Site Info</h3>
                <div id="siteInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // Check localStorage for QA issues
        function checkLocalStorage() {
            try {
                const data = localStorage.getItem('qa_issues');
                const status = document.getElementById('storageStatus');
                const dataView = document.getElementById('storageData');
                
                if (data) {
                    const issues = JSON.parse(data);
                    status.className = 'status success';
                    status.innerHTML = `‚úÖ Found ${issues.length} issue(s) in localStorage`;
                    dataView.style.display = 'block';
                    dataView.textContent = JSON.stringify(issues, null, 2);
                } else {
                    status.className = 'status warning';
                    status.innerHTML = '‚ö†Ô∏è No qa_issues found in localStorage';
                    dataView.style.display = 'none';
                }
            } catch (error) {
                document.getElementById('storageStatus').className = 'status error';
                document.getElementById('storageStatus').innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // Check all storage types
        function checkAllStorage() {
            const results = [];
            
            // Check localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('qa') || key.includes('issue'))) {
                    results.push({
                        type: 'localStorage',
                        key: key,
                        value: localStorage.getItem(key)
                    });
                }
            }
            
            // Check sessionStorage
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && (key.includes('qa') || key.includes('issue'))) {
                    results.push({
                        type: 'sessionStorage',
                        key: key,
                        value: sessionStorage.getItem(key)
                    });
                }
            }
            
            const status = document.getElementById('storageStatus');
            const dataView = document.getElementById('storageData');
            
            if (results.length > 0) {
                status.className = 'status success';
                status.innerHTML = `Found ${results.length} QA-related storage item(s)`;
                dataView.style.display = 'block';
                dataView.textContent = JSON.stringify(results, null, 2);
            } else {
                status.className = 'status warning';
                status.innerHTML = 'No QA-related data found in any storage';
                dataView.style.display = 'none';
            }
        }

        // Export localStorage to JSON file
        function exportLocalStorage() {
            const data = localStorage.getItem('qa_issues');
            if (data) {
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qa_issues_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                document.getElementById('storageStatus').className = 'status success';
                document.getElementById('storageStatus').innerHTML = '‚úÖ Exported to JSON file';
            } else {
                document.getElementById('storageStatus').className = 'status error';
                document.getElementById('storageStatus').innerHTML = '‚ùå No data to export';
            }
        }

        // Analyze uploaded JSON file
        async function analyzeJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const analysis = document.getElementById('jsonAnalysis');
                const dataView = document.getElementById('jsonData');
                
                let html = '<div class="status">';
                
                // Check if it's a valid QA export
                if (data.issues && Array.isArray(data.issues)) {
                    html += `<strong>‚úÖ Valid QA Export Format</strong><br>`;
                    html += `Export Date: ${data.exportDate || 'Unknown'}<br>`;
                    html += `Total Issues: ${data.issues.length}<br>`;
                    html += `<br><strong>Issues Summary:</strong><ul>`;
                    data.issues.slice(0, 5).forEach(issue => {
                        html += `<li>${issue.title} (${issue.priority || 'No priority'})</li>`;
                    });
                    if (data.issues.length > 5) {
                        html += `<li>...and ${data.issues.length - 5} more</li>`;
                    }
                    html += '</ul>';
                    
                    // Store for potential save
                    window.lastValidJSON = data.issues;
                    html += '<button onclick="saveValidJSON()">Save to localStorage</button>';
                } else if (Array.isArray(data)) {
                    html += `<strong>‚ö†Ô∏è Array Format Detected</strong><br>`;
                    html += `Total Items: ${data.length}<br>`;
                    html += `This might be a direct issues array. Converting...<br>`;
                    
                    window.lastValidJSON = data;
                    html += '<button onclick="saveValidJSON()">Save to localStorage</button>';
                } else {
                    html += `<strong>‚ùå Unknown Format</strong><br>`;
                    html += `Keys found: ${Object.keys(data).join(', ')}<br>`;
                }
                
                html += '</div>';
                analysis.innerHTML = html;
                
                dataView.style.display = 'block';
                dataView.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('jsonAnalysis').innerHTML = 
                    `<div class="status error">‚ùå Error parsing JSON: ${error.message}</div>`;
            }
        }

        // Save valid JSON to localStorage
        function saveValidJSON() {
            if (window.lastValidJSON) {
                localStorage.setItem('qa_issues', JSON.stringify(window.lastValidJSON));
                alert('Saved to localStorage! Refresh the QA page to see the import banner.');
            }
        }

        // Parse manual JSON
        function parseManualJSON() {
            const textarea = document.getElementById('manualJson');
            const status = document.getElementById('manualStatus');
            
            try {
                const data = JSON.parse(textarea.value);
                window.manualParsedData = Array.isArray(data) ? data : (data.issues || data);
                
                status.className = 'status success';
                status.innerHTML = `‚úÖ Parsed successfully! Found ${window.manualParsedData.length} items`;
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `‚ùå Parse error: ${error.message}`;
            }
        }

        // Save manual data to localStorage
        function saveAsLocalStorage() {
            if (window.manualParsedData) {
                localStorage.setItem('qa_issues', JSON.stringify(window.manualParsedData));
                document.getElementById('manualStatus').className = 'status success';
                document.getElementById('manualStatus').innerHTML = 
                    '‚úÖ Saved to localStorage! Refresh the QA page to see the import banner.';
            } else {
                document.getElementById('manualStatus').className = 'status error';
                document.getElementById('manualStatus').innerHTML = '‚ùå Parse the data first';
            }
        }

        // Download manual data as JSON
        function downloadAsJSON() {
            if (window.manualParsedData) {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    issueCount: window.manualParsedData.length,
                    issues: window.manualParsedData
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qa_issues_export_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Create test data
        function createTestData() {
            const issues = [
                {
                    id: "test-1-" + Date.now(),
                    title: "Test Issue 1",
                    description: "This is a test issue",
                    url: window.location.origin + "/",
                    priority: "High",
                    category: "Functionality",
                    status: "Open",
                    created_at: new Date().toISOString()
                },
                {
                    id: "test-2-" + Date.now(),
                    title: "Test Issue 2",
                    description: "Another test issue",
                    url: window.location.origin + "/qa",
                    priority: "Medium",
                    category: "UI/Design",
                    status: "Open",
                    created_at: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('qa_issues', JSON.stringify(issues));
            document.getElementById('testStatus').className = 'status success';
            document.getElementById('testStatus').innerHTML = '‚úÖ Test data created in localStorage';
        }

        // Create issues from yesterday
        function createFromYesterday() {
            const yesterday = new Date(Date.now() - 86400000);
            const issues = [
                {
                    id: "yesterday-1-" + Date.now(),
                    title: "Issue from yesterday",
                    description: "This was created yesterday",
                    url: window.location.origin + "/",
                    priority: "High",
                    category: "Functionality",
                    status: "Open",
                    created_at: yesterday.toISOString(),
                    updated_at: yesterday.toISOString()
                }
            ];
            
            localStorage.setItem('qa_issues', JSON.stringify(issues));
            document.getElementById('testStatus').className = 'status success';
            document.getElementById('testStatus').innerHTML = '‚úÖ Yesterday\'s test data created';
        }

        // Clear localStorage
        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear localStorage?')) {
                localStorage.removeItem('qa_issues');
                document.getElementById('testStatus').className = 'status warning';
                document.getElementById('testStatus').innerHTML = '‚ö†Ô∏è localStorage cleared';
            }
        }

        // Show diagnostics on load
        window.onload = function() {
            // Browser info
            document.getElementById('browserInfo').innerHTML = `
                <p>User Agent: ${navigator.userAgent.substring(0, 50)}...</p>
                <p>Platform: ${navigator.platform}</p>
                <p>Language: ${navigator.language}</p>
            `;
            
            // Storage info
            try {
                const estimate = navigator.storage && navigator.storage.estimate 
                    ? navigator.storage.estimate() 
                    : Promise.resolve({ usage: 0, quota: 0 });
                    
                estimate.then(data => {
                    document.getElementById('storageInfo').innerHTML = `
                        <p>localStorage items: ${localStorage.length}</p>
                        <p>sessionStorage items: ${sessionStorage.length}</p>
                        <p>Storage used: ${(data.usage / 1024 / 1024).toFixed(2)} MB</p>
                        <p>Storage quota: ${(data.quota / 1024 / 1024).toFixed(2)} MB</p>
                    `;
                });
            } catch (e) {
                document.getElementById('storageInfo').innerHTML = `
                    <p>localStorage items: ${localStorage.length}</p>
                    <p>sessionStorage items: ${sessionStorage.length}</p>
                `;
            }
            
            // Site info
            document.getElementById('siteInfo').innerHTML = `
                <p>Origin: ${window.location.origin}</p>
                <p>Current URL: ${window.location.href}</p>
                <p>Protocol: ${window.location.protocol}</p>
            `;
            
            // Auto-check localStorage
            checkLocalStorage();
        };
    </script>
</body>
</html>