# Claude Code Instructions for Wheels & Wins

## üìö Essential Context Files (Read These First)
When starting a new session, read these files to get up to speed:

- **@docs/pam-rebuild-2025/PAM_FINAL_PLAN.md** - Complete 7-day rebuild plan and progress
- **@docs/pam-rebuild-2025/DAY_4_COMPLETE.md** - Latest completed work
- **@backend/docs/architecture.md** - System architecture overview
- **@backend/docs/api.md** - API endpoint documentation
- **@CLAUDE.local.md** - Current session context (if exists)

## üöÄ Quick Start
**Dev Server**: http://localhost:8080 (NOT 3000!)
**Stack**: React 18.3 + TypeScript + Vite + Tailwind + Supabase + FastAPI

## üéØ Strategic AI Decision (January 2025)

**PAM AI Provider**: **Claude Sonnet 4.5** (Primary)
- ‚úÖ **Primary AI Brain**: Claude Sonnet 4.5 (`claude-sonnet-4-5-20250929`)
- ‚úÖ **Superior Performance**: State-of-the-art reasoning and function calling
- ‚úÖ **200K Token Context**: Massive context window for conversation history
- ‚úÖ **Best-in-Class**: Industry-leading accuracy and response quality
- ‚úÖ **Simple Architecture**: ONE AI brain via AsyncAnthropic client
- üîÑ **Gemini Flash Fallback**: Cost-effective backup for simple queries
- üîÑ **OpenAI Tertiary**: Available as additional fallback option
- üí∞ **Cost**: $3/1M input + $15/1M output tokens (Claude Sonnet 4.5)
- üìã **Reference**: See `/docs/pam-rebuild-2025/PAM_FINAL_PLAN.md` for full architecture

## Critical Commands
```bash
npm run dev              # Start dev server (port 8080)
npm run build            # Production build
npm run quality:check:full # Run all quality checks
npm test                 # Run tests
npm run lint             # ESLint
npm run type-check       # TypeScript validation
```

## üõ°Ô∏è Git Safety Systems (IMPORTANT FOR ALL SESSIONS)

### Available Git Safety Tools
- `scripts/git-safe` - Core corruption prevention system with flock protection
- `scripts/git-network-resilient` - Network-resilient operations with retry logic
- `scripts/git-health-monitor` - Repository health monitoring with daemon mode
- `scripts/git-script-auditor` - Audits and fixes unsafe Git patterns in scripts
- `scripts/install-git-safe.sh` - Universal installer for any repository

### Critical: Git Audit Artifacts (NEVER COMMIT THESE)
The following files are generated by git-script-auditor and should NEVER be committed:
```bash
.git/git-script-auditor/     # Audit logs, reports, backups
.git/git-safe/               # Safety system working files
.git/git-network-resilient/  # Network operation state
.git/git-health-monitor/     # Health monitoring data
*.git-safe.backup           # Backup files
REPO_HEALTH_CHECK.md        # Temporary health reports
scripts/git-safe-config     # Generated config files
git-safety-functions.sh     # Template functions
```

### Before ANY Git Operations
```bash
# Check repository health
scripts/git-health-monitor status

# Audit scripts for unsafe patterns  
scripts/git-script-auditor audit

# Use safe Git operations
scripts/git-safe git commit -m "message"
scripts/git-network-resilient push origin main
```

### If Repository Corruption Occurs
```bash
# Automatic recovery
scripts/git-safe recover

# Manual repair if needed
scripts/git-safe repair

# Nuclear option (last resort)
scripts/git-safe repair --nuclear
```

## Infrastructure Architecture

### Two-System Setup (CRITICAL: Staging & Production)
We operate **two complete separate systems** sharing one Supabase database:

#### üîµ Production System
- **Frontend**: wheelsandwins.com (Netlify main branch)
- **Backend**: pam-backend.onrender.com (Render)
- **Database**: Shared Supabase instance
- **Redis**: pam-redis.onrender.com (private network)
- **Workers**: pam-celery-worker.onrender.com, pam-celery-beat.onrender.com

#### üü° Staging System  
- **Frontend**: wheels-wins-staging.netlify.app (Netlify staging branch)
- **Backend**: wheels-wins-backend-staging.onrender.com (Render)
- **Database**: Same shared Supabase instance
- **Workers**: wheels-wins-celery-worker-staging.onrender.com

#### üîÑ Shared Services
- **Database**: Single Supabase PostgreSQL (shared between systems)
- **Data Collector**: wheels-wins-data-collector.onrender.com
- **Redis**: Separate Redis instances per environment

### Environment Variable Configuration

**CRITICAL**: Each frontend must point to its corresponding backend!
- Production frontend ‚Üí Production backend (pam-backend.onrender.com)
- Staging frontend ‚Üí Staging backend (wheels-wins-backend-staging.onrender.com)

### System Architecture Overview
```
Production:
Frontend (wheelsandwins.com) ‚óÑ‚îÄ‚îÄ‚ñ∫ Backend (pam-backend) ‚óÑ‚îÄ‚îÄ‚ñ∫ Shared Services
‚îú‚îÄ‚îÄ React/TS/PWA (Netlify)         ‚îú‚îÄ‚îÄ FastAPI/Redis               ‚îú‚îÄ‚îÄ Supabase DB
‚îú‚îÄ‚îÄ Vite 5.4.19                    ‚îú‚îÄ‚îÄ Celery Workers              ‚îú‚îÄ‚îÄ Mapbox GL
‚îú‚îÄ‚îÄ Tailwind 3.4.11                ‚îú‚îÄ‚îÄ WebSocket                   ‚îú‚îÄ‚îÄ Google Gemini Flash
‚îî‚îÄ‚îÄ PWA Manifest                   ‚îî‚îÄ‚îÄ TTS/STT                     ‚îî‚îÄ‚îÄ Data Collector

Staging:
Frontend (staging.netlify.app) ‚óÑ‚îÄ‚îÄ‚ñ∫ Backend (staging.onrender.com) ‚óÑ‚îÄ‚îÄ‚ñ∫ Shared Services
‚îú‚îÄ‚îÄ React/TS/PWA (Netlify)          ‚îú‚îÄ‚îÄ FastAPI/Redis                ‚îú‚îÄ‚îÄ Supabase DB
‚îú‚îÄ‚îÄ Vite 5.4.19                     ‚îú‚îÄ‚îÄ Celery Workers               ‚îú‚îÄ‚îÄ Mapbox GL
‚îú‚îÄ‚îÄ Tailwind 3.4.11                 ‚îú‚îÄ‚îÄ WebSocket                    ‚îú‚îÄ‚îÄ Google Gemini Flash
‚îî‚îÄ‚îÄ PWA Manifest                    ‚îî‚îÄ‚îÄ TTS/STT                      ‚îî‚îÄ‚îÄ Data Collector
```

## Environment Variables

### Frontend (.env)
```bash
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_anon_key
VITE_MAPBOX_TOKEN=pk.your_mapbox_token
VITE_GEMINI_API_KEY=your_gemini_api_key
```

### Backend (backend/.env)
```bash
DATABASE_URL=postgresql://...
SUPABASE_SERVICE_ROLE_KEY=...
GEMINI_API_KEY=your_gemini_api_key
ANTHROPIC_API_KEY=your_anthropic_fallback_key
TTS_ENABLED=true
REDIS_URL=redis://localhost:6379
```

## Project Structure
```
src/
‚îú‚îÄ‚îÄ components/      # UI components
‚îÇ   ‚îú‚îÄ‚îÄ wheels/     # Trip planning
‚îÇ   ‚îú‚îÄ‚îÄ wins/       # Financial
‚îÇ   ‚îú‚îÄ‚îÄ social/     # Community
‚îÇ   ‚îî‚îÄ‚îÄ pam/        # AI assistant
‚îú‚îÄ‚îÄ pages/          # Routes
‚îú‚îÄ‚îÄ hooks/          # Custom hooks
‚îú‚îÄ‚îÄ services/       # API clients
‚îî‚îÄ‚îÄ __tests__/      # Tests
```

## Deployment

### Frontend (Netlify - 2 Sites)
1. **Production**: main branch ‚Üí wheelsandwins.com
2. **Staging**: staging branch ‚Üí wheels-wins-staging.netlify.app
- **Build**: `npm run build`

### Backend (Render - 7 Services Total)

#### Production Services
1. **pam-backend**: https://pam-backend.onrender.com (main backend)
2. **pam-redis**: Private network cache for production
3. **pam-celery-worker**: Production background tasks
4. **pam-celery-beat**: Production task scheduler

#### Staging Services  
5. **wheels-wins-backend-staging**: https://wheels-wins-backend-staging.onrender.com
6. **wheels-wins-celery-worker-staging**: Staging background tasks

#### Shared Services
7. **wheels-wins-data-collector**: https://wheels-wins-data-collector.onrender.com

### Database (Supabase - Shared)
- **Single PostgreSQL instance** shared between staging and production
- RLS policies distinguish between environments via user context
- Tables: profiles, user_settings, pam_conversations, expenses, budgets
- Daily backups

## PAM AI Assistant Issues

### Known Problems
1. **Multiple WebSocket implementations** (4 versions!)
   - pamService.ts, usePamWebSocket.ts, usePamWebSocketConnection.ts, usePamWebSocketV2.ts
2. **Duplicate components**: Pam.tsx AND PamAssistant.tsx
3. **WebSocket URL**: Must include user_id: `/api/v1/pam/ws/${userId}?token=${token}`

### PAM Connection Endpoints

#### Production
- **WebSocket**: `wss://pam-backend.onrender.com/api/v1/pam/ws/{user_id}?token={jwt}`
- **Health**: https://pam-backend.onrender.com/api/health

#### Staging  
- **WebSocket**: `wss://wheels-wins-backend-staging.onrender.com/api/v1/pam/ws/{user_id}?token={jwt}`
- **Health**: https://wheels-wins-backend-staging.onrender.com/api/health

**IMPORTANT**: Each frontend must connect to its corresponding backend environment!

## MCP Servers Configuration

### Available MCP Servers
1. **Supabase**: Direct SQL operations
   - **Capabilities**: Direct database access, table management, storage operations
   - **Project URL**: https://ydevatqwkoccxhtejdor.supabase.co
   - **Service Role**: Available for admin operations
   - **Access Level**: Full read/write access via service role key
   - **What Claude Can Do**:
     - Read all tables (bypassing RLS)
     - Update/INSERT/DELETE records directly
     - Create/modify tables and schemas
     - Execute any SQL queries
     - Manage storage buckets
   - **Security**: Service role key stored locally only, never in codebase
   - **Use Cases**: Direct database fixes, data migrations, troubleshooting RLS issues
2. **Serena**: Semantic code analysis
3. **Render**: Deployment management
4. **Code Analyzer**: AI-powered integration

### Setup
```bash
# Supabase
npm install -g @supabase/mcp-server-supabase

# Serena (via uvx)
uvx --from git+https://github.com/oraios/serena serena-mcp-server --help

# Render
npm install -g @render/mcp-server
```

Configuration: `~/.config/claude-desktop/claude_desktop_config.json`

## üîÑ Development Workflow

### **Our Standard Development Process**
Follow this structured approach for all features and fixes:

1. **Plan the Architecture** 
   - Create PRD (Product Requirements Document) using PLAN.md template
   - Write ADR (Architecture Decision Record) for technical decisions
   - Define system structure and component relationships

2. **Define Types and Tests as Guardrails**
   - Establish TypeScript interfaces and types first
   - Write test cases before implementation (TDD approach)
   - Create API contracts and data schemas

3. **Build with Parallel Agents**
   - Deploy specialized agents for different domains
   - Use `/double escape` for concurrent development streams
   - Coordinate through main session with context sharing

4. **Review Tests and Key Decisions**
   - Validate implementation against initial test cases
   - Review architecture decisions and document changes
   - Ensure quality standards and security requirements

5. **Document Everything in ADR**
   - Record all significant technical decisions
   - Update context files (cloud.md) with architectural changes
   - Maintain decision rationale for future reference

6. **Repeat with Full Context Preserved**
   - Archive completed work in context system
   - Update PLAN.md with lessons learned
   - Preserve knowledge for future iterations

### **Workflow Tools**
- **PLAN.md**: Structured planning templates in project root
- **cloud.md files**: Architecture and context documentation per subsystem
- **ADR templates**: Decision record formats in `/docs/decisions/`
- **`/double escape`**: Parallel agent deployment command
- **`/resume [context]`**: Context restoration between sessions
- **GitHub Integration**: Automated PR generation with context-rich descriptions

### **Branch Protection & PR Requirements**
- **Protected Branches**: staging and main branches are protected
- **Pull Request Required**: All commits must be made to non-protected branches and submitted via PR
- **Approval Required**: Pull requests require approval before merging
- **No Direct Pushes**: Cannot push directly to protected branches
- **Workflow**: Create feature branch ‚Üí make changes ‚Üí submit PR ‚Üí get approval ‚Üí merge

### **Quality Gates**
- All implementations must have corresponding tests
- TypeScript strict mode compliance required
- Security review for authentication and data handling
- Performance benchmarks for user-facing features
- Documentation updates for architectural changes

## Recent Fixes (January 2025)

### ‚úÖ Fixed Issues
1. **Animation System**: Removed problematic page transitions
2. **WebSocket Stability**: Fixed connection state management
3. **Database**: Fixed RLS recursion, created missing tables
4. **Environment Variables**: Smart detection for swapped values
5. **Serena Integration**: Semantic code analysis enabled

### Files Updated
- `src/App.tsx` - Removed animations
- `src/integrations/supabase/client.ts` - Smart env detection
- `backend/app/api/v1/pam.py` - WebSocket fixes
- `supabase/migrations/` - Database fixes

## Current QA Issues (August 2025)

### Priority Fixes
1. ‚úÖ **Profile Settings**: Fixed sync with retry logic
2. ‚úÖ **Income Page**: Fixed duplicate buttons
3. ‚úÖ **Social Avatars**: Added fallback system
4. ‚úÖ **Savings Challenge**: Added button functionality
5. ‚úÖ **Budget Editor**: Extended date range
6. ‚úÖ **Money Maker**: Added onboarding guidance

## UI/UX Guidelines

### Navigation Hierarchy
- Keep to 3 levels maximum
- Primary actions in header
- Use segmented controls for view switching
- Mobile-first design

### Recent Improvements
- **Expenses Page**: Simplified from 4 to 3 navigation levels
- **Bank Statement Import**: Privacy-first, multi-format support
- **Components**: Clear visual hierarchy with proper spacing

### Bank Statement Converter
- **Privacy**: Client-side processing
- **Formats**: CSV, Excel, PDF
- **Security**: Auto-anonymization, GDPR compliant
- **Files**: `src/components/bank-statement/`, `src/services/bankStatement/`

## Development Guidelines

### Code Standards
- **TypeScript**: Strict mode (currently false for dev velocity)
- **Testing**: 80%+ coverage requirement
- **Mobile-first**: Responsive design
- **Accessibility**: WCAG compliance
- **No mock data**: Production-ready code only

### SQL File Guidelines
- **No Comments**: When creating SQL files, write only clean SQL statements
- **No Instructions**: Never include "run separately" or other execution instructions
- **Batch Execution**: All SQL should be designed to run as a complete script
- **Clean Format**: One statement per line, no explanatory text
- **Location**: Always save SQL files in `docs/sql-fixes/` folder

### Bundle Strategy (vite.config.ts)
```javascript
{
  'react-vendor': ['react', 'react-dom'],
  'mapbox-vendor': ['mapbox-gl'],
  'radix-vendor': [...],
  'chart-vendor': ['recharts'],
  'utils-vendor': ['clsx', 'tailwind-merge']
}
```

### Component Template
```typescript
interface ComponentProps {
  title: string;
  onAction: (data: string) => void;
  isLoading?: boolean;
}

export const MyComponent: React.FC<ComponentProps> = ({
  title,
  onAction,
  isLoading = false
}) => {
  // Implementation
};
```

## Security Best Practices
- Supabase Auth with JWT
- RLS on all tables
- Input validation
- XSS prevention
- Rate limiting
- GDPR compliance

## Common Pitfalls
1. **Port**: Use 8080, NOT 3000
2. **PAM**: Don't create new implementations, fix existing
3. **Env vars**: Use VITE_ prefix for frontend
4. **Staging**: Always test there first
5. **RLS**: Test for recursion
6. **Environment Mismatch**: Staging frontend pointing to production backend
7. **CORS Issues**: Backend CORS origins must include both staging and production URLs
8. **JWT Secrets**: Must match between frontend and corresponding backend environment

## Environment Troubleshooting

### Critical Environment Checks
When debugging staging/production issues, verify:

1. **Frontend‚ÜíBackend Mapping**:
   ```bash
   # Production should use:
   VITE_API_BASE_URL=https://pam-backend.onrender.com
   
   # Staging should use:  
   VITE_API_BASE_URL=https://wheels-wins-backend-staging.onrender.com
   ```

2. **Backend CORS Configuration**:
   ```python
   # Backend main.py must include both:
   "https://wheelsandwins.com",
   "https://wheels-wins-staging.netlify.app"
   ```

3. **JWT Token Compatibility**:
   - Staging frontend + staging backend = ‚úÖ
   - Production frontend + production backend = ‚úÖ  
   - Cross-environment = ‚ùå (JWT decode failures)

### Common Error Patterns
- `"<!doctype"... is not valid JSON` = CORS/Environment mismatch
- `JWT decode failed: Signature verification failed` = Wrong backend for environment
- `Cannot connect to PAM backend` = Environment variable pointing to wrong backend

## Key Files
- `vite.config.ts` - Build configuration
- `src/hooks/useUserSettings.ts` - Settings sync
- `backend/app/api/v1/pam.py` - PAM WebSocket
- `docs/pam-current-state-breakdown.md` - Technical debt

## Testing Checklist
- [ ] Mobile responsive (375px, 768px, 1024px)
- [ ] Touch targets (min 44x44px)
- [ ] Dark mode
- [ ] Keyboard navigation
- [ ] Screen reader
- [ ] Loading/error/empty states

## Quick Debug
```bash
# Check TypeScript
npm run type-check

# Full quality check
npm run quality:check:full

# Backend server
cd backend && uvicorn app.main:app --reload --port 8000

# Test coverage
npm run test:coverage
```

---
**Remember**: This is a production app with real users. Test thoroughly, especially on mobile!