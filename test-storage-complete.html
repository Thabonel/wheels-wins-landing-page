<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Complete Supabase Storage Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .warning {
            background: #fed7aa;
            color: #92400e;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .uploaded-image {
            max-width: 200px;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Complete Supabase Storage Test Suite</h1>
        
        <!-- Authentication Section -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Authentication</h2>
            <button onclick="testAuth()">Login with Test Account</button>
            <button onclick="checkAuth()">Check Auth Status</button>
            <div id="authResult" class="result"></div>
        </div>

        <!-- Storage Health Check -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Storage Health Check</h2>
            <button onclick="checkStorage()">Check Storage Setup</button>
            <button onclick="listBuckets()">List All Buckets</button>
            <div id="storageResult" class="result"></div>
        </div>

        <!-- Upload Test -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Upload Test</h2>
            <input type="file" id="fileInput" accept="image/*">
            <br>
            <button onclick="testUpload('avatars')">Upload to Avatars</button>
            <button onclick="testUpload('profile-images')">Upload to Profile Images</button>
            <div id="uploadResult" class="result"></div>
        </div>

        <!-- List Files -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ List Uploaded Files</h2>
            <button onclick="listFiles('avatars')">List Avatars</button>
            <button onclick="listFiles('profile-images')">List Profile Images</button>
            <div id="listResult" class="result"></div>
        </div>

        <!-- Delete Test -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Delete Test</h2>
            <input type="text" id="deleteFilePath" placeholder="Enter file path to delete" style="width: 300px; padding: 8px;">
            <br>
            <button onclick="deleteFile('avatars')">Delete from Avatars</button>
            <button onclick="deleteFile('profile-images')">Delete from Profile Images</button>
            <div id="deleteResult" class="result"></div>
        </div>

        <!-- Direct SQL Test -->
        <div class="test-section">
            <h2>6Ô∏è‚É£ Database Direct Check</h2>
            <button onclick="checkDatabase()">Check Storage Tables</button>
            <div id="dbResult" class="result"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://kycoklimpzkyrecbjecn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5Y29rbGltcHpreXJlY2JqZWNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQyMzU4MzEsImV4cCI6MjAyOTgxMTgzMX0.cFT9UFWM63WBMFNaKS9LoRvPxMr9L2Bl94adBjSH3o4';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Test credentials
        const TEST_EMAIL = 'test@example.com';
        const TEST_PASSWORD = 'Test123456!';

        // Helper function to display results
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        // 1. Authentication
        async function testAuth() {
            showResult('authResult', 'Authenticating...', 'info');
            
            try {
                // Try to sign in first
                let { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: TEST_EMAIL,
                    password: TEST_PASSWORD
                });

                // If sign in fails, try to sign up
                if (error) {
                    showResult('authResult', `Sign in failed, trying sign up... ${error.message}`, 'warning');
                    
                    ({ data, error } = await supabaseClient.auth.signUp({
                        email: TEST_EMAIL,
                        password: TEST_PASSWORD
                    }));

                    if (error) throw error;
                }

                showResult('authResult', `‚úÖ Authenticated successfully!\nUser ID: ${data.user?.id}\nEmail: ${data.user?.email}`, 'success');
            } catch (error) {
                showResult('authResult', `‚ùå Authentication failed: ${error.message}`, 'error');
            }
        }

        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    showResult('authResult', `‚úÖ Logged in as: ${user.email}\nID: ${user.id}`, 'success');
                } else {
                    showResult('authResult', '‚ö†Ô∏è Not authenticated. Please login first.', 'warning');
                }
            } catch (error) {
                showResult('authResult', `‚ùå Auth check failed: ${error.message}`, 'error');
            }
        }

        // 2. Storage Health Check
        async function checkStorage() {
            showResult('storageResult', 'Checking storage configuration...', 'info');
            
            try {
                // Check if we can access storage
                const { data: buckets, error } = await supabaseClient.storage.listBuckets();
                
                if (error) throw error;
                
                let report = 'üìä Storage Health Report\n';
                report += '========================\n\n';
                report += `‚úÖ Storage API accessible\n`;
                report += `üì¶ Total buckets: ${buckets?.length || 0}\n\n`;
                
                // Check specific buckets
                const expectedBuckets = ['avatars', 'profile-images'];
                for (const bucketName of expectedBuckets) {
                    const exists = buckets?.some(b => b.id === bucketName || b.name === bucketName);
                    report += `${exists ? '‚úÖ' : '‚ùå'} Bucket "${bucketName}": ${exists ? 'EXISTS' : 'MISSING'}\n`;
                    
                    if (exists) {
                        const bucket = buckets.find(b => b.id === bucketName || b.name === bucketName);
                        report += `   - Public: ${bucket.public}\n`;
                        report += `   - Created: ${bucket.created_at}\n`;
                    }
                }
                
                showResult('storageResult', report, 'success');
            } catch (error) {
                showResult('storageResult', `‚ùå Storage check failed: ${error.message}\n\nThis likely means storage is not properly configured.`, 'error');
            }
        }

        async function listBuckets() {
            try {
                const { data, error } = await supabaseClient.storage.listBuckets();
                
                if (error) throw error;
                
                showResult('storageResult', `üì¶ Buckets:\n${JSON.stringify(data, null, 2)}`, 'info');
            } catch (error) {
                showResult('storageResult', `‚ùå Failed to list buckets: ${error.message}`, 'error');
            }
        }

        // 3. Upload Test
        async function testUpload(bucketName) {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('uploadResult', '‚ö†Ô∏è Please select a file first', 'warning');
                return;
            }

            showResult('uploadResult', `Uploading to ${bucketName}...`, 'info');

            try {
                // Check auth first
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) {
                    throw new Error('You must be logged in to upload files');
                }

                // Generate unique filename
                const fileName = `${user.id}/${Date.now()}-${file.name}`;
                
                // Upload file
                const { data, error } = await supabaseClient.storage
                    .from(bucketName)
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) throw error;

                // Get public URL
                const { data: { publicUrl } } = supabaseClient.storage
                    .from(bucketName)
                    .getPublicUrl(fileName);

                let result = `‚úÖ Upload successful!\n`;
                result += `üìÅ Bucket: ${bucketName}\n`;
                result += `üìÑ Path: ${data.path}\n`;
                result += `üîó Public URL: ${publicUrl}\n\n`;
                result += `<img src="${publicUrl}" class="uploaded-image">`;
                
                const resultDiv = document.getElementById('uploadResult');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = result;
            } catch (error) {
                showResult('uploadResult', `‚ùå Upload failed: ${error.message}`, 'error');
            }
        }

        // 4. List Files
        async function listFiles(bucketName) {
            showResult('listResult', `Fetching files from ${bucketName}...`, 'info');
            
            try {
                const { data, error } = await supabaseClient.storage
                    .from(bucketName)
                    .list();

                if (error) throw error;

                if (data && data.length > 0) {
                    let result = `üìÅ Files in "${bucketName}":\n`;
                    result += '========================\n\n';
                    
                    data.forEach(file => {
                        result += `üìÑ ${file.name}\n`;
                        result += `   Size: ${(file.metadata?.size || 0) / 1024} KB\n`;
                        result += `   Created: ${file.created_at}\n\n`;
                    });
                    
                    showResult('listResult', result, 'success');
                } else {
                    showResult('listResult', `üì≠ No files found in "${bucketName}"`, 'warning');
                }
            } catch (error) {
                showResult('listResult', `‚ùå Failed to list files: ${error.message}`, 'error');
            }
        }

        // 5. Delete File
        async function deleteFile(bucketName) {
            const filePath = document.getElementById('deleteFilePath').value.trim();
            
            if (!filePath) {
                showResult('deleteResult', '‚ö†Ô∏è Please enter a file path', 'warning');
                return;
            }

            showResult('deleteResult', `Deleting ${filePath} from ${bucketName}...`, 'info');

            try {
                const { data, error } = await supabaseClient.storage
                    .from(bucketName)
                    .remove([filePath]);

                if (error) throw error;

                showResult('deleteResult', `‚úÖ Successfully deleted: ${filePath}`, 'success');
            } catch (error) {
                showResult('deleteResult', `‚ùå Delete failed: ${error.message}`, 'error');
            }
        }

        // 6. Database Direct Check
        async function checkDatabase() {
            showResult('dbResult', 'Checking database tables...', 'info');
            
            try {
                // Check if storage schema exists
                const { data: schemas, error: schemaError } = await supabaseClient.rpc('get_schemas');
                
                // Check buckets
                const { data: buckets, error: bucketsError } = await supabaseClient
                    .from('buckets')
                    .select('*')
                    .in('id', ['avatars', 'profile-images']);

                // Check if we can query objects table
                const { count, error: objectsError } = await supabaseClient
                    .from('objects')
                    .select('*', { count: 'exact', head: true });

                let report = 'üóÑÔ∏è Database Status\n';
                report += '==================\n\n';
                
                if (bucketsError) {
                    report += `‚ùå storage.buckets table: ERROR - ${bucketsError.message}\n`;
                } else {
                    report += `‚úÖ storage.buckets table: ACCESSIBLE\n`;
                    report += `   Found ${buckets?.length || 0} relevant buckets\n`;
                }
                
                if (objectsError) {
                    report += `‚ùå storage.objects table: ERROR - ${objectsError.message}\n`;
                } else {
                    report += `‚úÖ storage.objects table: ACCESSIBLE\n`;
                    report += `   Total objects: ${count || 0}\n`;
                }
                
                showResult('dbResult', report, bucketsError || objectsError ? 'error' : 'success');
            } catch (error) {
                showResult('dbResult', `‚ùå Database check failed: ${error.message}`, 'error');
            }
        }

        // Auto-check auth on load
        window.addEventListener('load', () => {
            checkAuth();
        });
    </script>
</body>
</html>