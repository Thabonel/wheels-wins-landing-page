<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAM Simple Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .connected { background: #d4edda; color: #155724; }
        .connecting { background: #fff3cd; color: #856404; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .log {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .timestamp {
            color: #6c757d;
            margin-right: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>PAM WebSocket Connection Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div style="margin: 20px 0;">
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
        <button id="sendTestBtn" disabled>Send Test Message</button>
        <button id="clearLogBtn">Clear Log</button>
    </div>
    
    <h3>Connection Log</h3>
    <div id="log" class="log">
        <div class="log-entry">Waiting for connection...</div>
    </div>

    <script>
        const BACKEND_URL = 'wss://pam-backend.onrender.com';
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendTestBtn = document.getElementById('sendTestBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">${timestamp}</span> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStatus(state, text) {
            status.className = `status ${state}`;
            status.textContent = text;
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('Already connected');
                return;
            }
            
            // For testing, we'll use a simple user ID
            const userId = 'test-user-' + Date.now();
            const wsUrl = `${BACKEND_URL}/api/v1/pam/ws/${userId}`;
            
            addLog(`Connecting to ${wsUrl}...`);
            updateStatus('connecting', 'Connecting...');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    addLog('‚úÖ WebSocket connected successfully!', 'success');
                    updateStatus('connected', 'Connected');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendTestBtn.disabled = false;
                    reconnectAttempts = 0;
                    
                    // Send initial message
                    const initMessage = {
                        type: 'init',
                        userId: userId,
                        timestamp: Date.now()
                    };
                    ws.send(JSON.stringify(initMessage));
                    addLog(`Sent init message: ${JSON.stringify(initMessage)}`);
                };
                
                ws.onmessage = (event) => {
                    addLog(`üì• Received: ${event.data}`, 'message');
                };
                
                ws.onerror = (error) => {
                    addLog(`‚ùå WebSocket error: ${error.type}`, 'error');
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = (event) => {
                    addLog(`WebSocket closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`, 'warning');
                    updateStatus('disconnected', 'Disconnected');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendTestBtn.disabled = true;
                    
                    // Auto-reconnect logic
                    if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        addLog(`Will attempt reconnect ${reconnectAttempts}/${maxReconnectAttempts} in ${delay/1000}s...`);
                        setTimeout(connect, delay);
                    }
                };
                
            } catch (error) {
                addLog(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
                updateStatus('disconnected', 'Connection Failed');
            }
        }
        
        function disconnect() {
            if (ws) {
                reconnectAttempts = maxReconnectAttempts; // Prevent auto-reconnect
                ws.close(1000, 'User requested disconnect');
                ws = null;
            }
        }
        
        function sendTestMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'message',
                    content: 'Hello PAM! This is a test message.',
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(message));
                addLog(`üì§ Sent: ${JSON.stringify(message)}`, 'sent');
            } else {
                addLog('Cannot send message - not connected', 'error');
            }
        }
        
        function clearLog() {
            log.innerHTML = '';
            addLog('Log cleared');
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendTestBtn.addEventListener('click', sendTestMessage);
        clearLogBtn.addEventListener('click', clearLog);
        
        // Test backend health on page load
        fetch('https://pam-backend.onrender.com/api/health')
            .then(response => response.json())
            .then(data => {
                addLog(`‚úÖ Backend health check passed: ${JSON.stringify(data)}`, 'success');
            })
            .catch(error => {
                addLog(`‚ùå Backend health check failed: ${error.message}`, 'error');
            });
    </script>
</body>
</html>