<!DOCTYPE html>
<html>
<head>
    <title>CORS Test for PAM Backend</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
        }
        .success { border-color: #00ff00; }
        .error { border-color: #ff0000; color: #ff0000; }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00ff00;
            color: #000;
        }
    </style>
</head>
<body>
    <h1>üîç PAM Backend CORS Configuration Test</h1>
    
    <div>
        <button onclick="testCorsDebug()">Test CORS Debug Endpoint</button>
        <button onclick="testHealthEndpoint()">Test Health Endpoint</button>
        <button onclick="testChatEndpoint()">Test Chat Endpoint</button>
        <button onclick="testAllEndpoints()">Run All Tests</button>
    </div>
    
    <div id="results"></div>

    <script>
        const BACKEND_URL = 'https://wheels-wins-backend-staging.onrender.com';
        const resultsDiv = document.getElementById('results');

        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : 'success');
            div.textContent = `[${new Date().toISOString()}] ${message}`;
            resultsDiv.appendChild(div);
            console.log(message);
        }

        async function testCorsDebug() {
            log('Testing CORS Debug Endpoint...');
            try {
                const response = await fetch(`${BACKEND_URL}/api/cors/debug`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ CORS Debug Success: Origin allowed = ${data.origin_allowed}`);
                    log(`   Request origin: ${data.request_origin}`);
                    log(`   Total configured origins: ${data.total_origins}`);
                    log(`   Environment: ${data.environment}`);
                    console.log('Full CORS config:', data);
                } else {
                    log(`‚ùå CORS Debug Failed: ${response.status} ${response.statusText}`, true);
                }
            } catch (error) {
                log(`‚ùå CORS Debug Error: ${error.message}`, true);
                console.error('Full error:', error);
            }
        }

        async function testHealthEndpoint() {
            log('Testing Health Endpoint...');
            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/pam/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Health Check Success: Status = ${data.status}`);
                } else {
                    log(`‚ùå Health Check Failed: ${response.status} ${response.statusText}`, true);
                }
            } catch (error) {
                log(`‚ùå Health Check Error: ${error.message}`, true);
            }
        }

        async function testChatEndpoint() {
            log('Testing Chat Endpoint (OPTIONS preflight)...');
            try {
                // First test OPTIONS preflight
                const optionsResponse = await fetch(`${BACKEND_URL}/api/v1/pam/chat`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type,authorization',
                    },
                });
                
                if (optionsResponse.ok || optionsResponse.status === 204) {
                    log(`‚úÖ OPTIONS Preflight Success`);
                    
                    // Check CORS headers
                    const corsHeaders = {
                        'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
                        'Access-Control-Allow-Credentials': optionsResponse.headers.get('Access-Control-Allow-Credentials'),
                        'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
                        'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers'),
                    };
                    
                    log(`   CORS Headers: ${JSON.stringify(corsHeaders, null, 2)}`);
                } else {
                    log(`‚ùå OPTIONS Preflight Failed: ${optionsResponse.status}`, true);
                }
                
                // Now test actual POST
                log('Testing Chat Endpoint (POST)...');
                const postResponse = await fetch(`${BACKEND_URL}/api/v1/pam/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: 'Hello PAM! This is a CORS test.',
                        user_id: 'test-user'
                    })
                });
                
                if (postResponse.ok) {
                    const data = await postResponse.json();
                    log(`‚úÖ Chat POST Success: Got response`);
                    console.log('Chat response:', data);
                } else {
                    const errorText = await postResponse.text();
                    log(`‚ùå Chat POST Failed: ${postResponse.status} - ${errorText}`, true);
                }
            } catch (error) {
                log(`‚ùå Chat Endpoint Error: ${error.message}`, true);
                console.error('Full error:', error);
            }
        }

        async function testAllEndpoints() {
            resultsDiv.innerHTML = '';
            log('=== Starting Comprehensive CORS Test ===');
            await testCorsDebug();
            await testHealthEndpoint();
            await testChatEndpoint();
            log('=== Test Complete ===');
        }

        // Show current origin
        log(`Current Origin: ${window.location.origin}`);
        log(`Target Backend: ${BACKEND_URL}`);
    </script>
</body>
</html>